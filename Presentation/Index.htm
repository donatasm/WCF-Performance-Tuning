<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>
      WCF Performance Tuning, .NET UG Donatas Mažionis 2012-03-21(22)
    </title>
    <meta name="author" content="Donatas Mažionis" />
    <link href="css/impress.css" rel="stylesheet" />
</head>
<body>

<div id="impress" class="impress-not-supported">

    <div class="fallback-message">
        <p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
        <p>For the best experience please use the latest <b>Chrome</b> or <b>Safari</b> browser. Firefox 10 (to be released soon) will also handle it.</p>
    </div>

    <div id="start" class="step main-title" data-x="-1000" data-y="-1500">
        <q><strong>WCF Performance Tuning</strong></q>
        <p class="author"><a class="twitter-follow-button" href="http://twitter.com/donatasm">Donatas Mažionis (@donatasm)</a>, .NET UG 2012-03-21(22)</p>
    </div>

    <div class="step" data-x="0" data-y="-1500">
        <q>WCF framework</q>
        <ul class="bullet">
            <li>is de-facto framework for distributed systems in .NET</li>
            <li>supports various message exchange patterns and formats</li>
            <li>is extensible and customizable</li>
        </ul>
    </div>

    <div class="step" data-x="1000" data-y="-1500">
        <q>Basis of a WCF service</q>
        <ul class="bullet">
            <li>
                <strong>A</strong>ddress
                <ul class="small-list">
                    <li>http://my.api.services.net/customers</li>
                    <li>net.tcp://super.service/contacts</li>
                    <li></li>
                </ul>
            </li>
            <li>
                <strong>B</strong>inding
                <ul class="small-list">
                    <li>Transport protocol</li>
                    <li>Message enconding</li>
                    <li>Communication pattern</li>
                    <li>Reliability</li>
                    <li>Security</li>
                    <li>Transaction propagation</li>
                    <li>Interoperability</li>
                </ul>
            </li>
            <li>
                <strong>C</strong>ontract
                <ul class="small-list">
                    <li>Data contract</li>
                    <li>Operation contract</li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="step" data-x="2000" data-y="-1500">
        <q>WCF bindings</q>
        <ul id="binding-cloud">
            <li class="tag3">BasicHttpBinding</li>
            <li class="tag2">WSHttpBinding</li>
            <li class="tag1">WSDualHttpBinding</li>
            <li class="tag1">WSFederationHttpBinding</li>
            <li class="tag1">MsmqIntegrationBinding</li>
            <li class="tag2">NetNamedPipeBinding</li>
            <li class="tag1">NetMsmqBinding</li>
            <li class="tag1">NetPeerTcpBinding</li>
            <li class="tag3">NetTcpBinding</li>
        </ul>
    </div>

    <div class="step" data-x="3000" data-y="-1500">
        <ul class="gray">
            <li class="tag2">Out of the box tuned for all occasions</li>
            <li class="tag3">Except performance!</li>
        </ul>
    </div>

    <div class="step" data-x="4000" data-y="-1500">
        <q>Defining "fast" WCF service:</q>
        <ul class="bullet">
            <li>up to 100ms response time</li>
            <li>able to handle more than 2K req/sec over HTTP</li>
        </ul>
    </div>

    <div class="step" data-x="5000" data-y="-1500">
        <q>Choosing fast data contract formats</q>
        <ul class="bullet">
            <li>JSON (vs XML)<p><a href="http://www.json.org/">http://www.json.org/</a></p></li>
            <li>Google Protocol Buffers (vs Binary)<p><a href="http://code.google.com/apis/protocolbuffers/">http://code.google.com/apis/protocolbuffers/</a></p></li>
        </ul>
    </div>

    <div class="step" data-x="6000" data-y="-1500">
        <q>Google protocol buffers</q>
        <ul class="bullet">
          <li>Very fast, compact</li>
          <li>Getting popular fast too</li>
          <li>Several .NET implementations: protobuf-net, proto#, dotnet-protobufs</li>
		  <li>NetTcp + ProtoBuf = Super Fast</li>
        </ul>
    </div>

    <div class="step" data-x="7000" data-y="-1500">
        <q>Serialization benchmarks</q>
        <img src="img/serialization.png" alt="Serialization performance" />
        <div><a class="source-link" href="http://www.servicestack.net/benchmarks/NorthwindDatabaseRowsSerialization.100000-times.2010-08-17.html">http://www.servicestack.net/benchmarks/NorthwindDatabaseRowsSerialization.100000-times.2010-08-17.html</a></div>
    </div>

    <div class="step" data-x="8000" data-y="-1500">
        <q>Demo #1. Pluging-in custom serializers</q>
    </div>

    <div class="step" data-x="9000" data-y="-1500">
        <q>Gotcha</q>
        <ul>
          <li>DataContractSerializerOperationBehavior will not work with WebHttpBehavior</li>
          <li><a class="source-link" href="http://stackoverflow.com/questions/1174486/what-could-be-the-reason-that-my-custom-rest-serializer-is-not-working">http://stackoverflow.com/questions/1174486/what-could-be-the-reason-that-my-custom-rest-serializer-is-not-working</a></li>
          <li><a class="source-link" href="http://social.msdn.microsoft.com/Forums/en-US/wcf/thread/1578a7e8-94d3-478c-b86e-73d2ab07f2eb">http://social.msdn.microsoft.com/Forums/en-US/wcf/thread/1578a7e8-94d3-478c-b86e-73d2ab07f2eb</a></li>
        </ul>
    </div>

    <div class="step" data-x="10000" data-y="-1500">
        <q>Tuning ServiceThrottlingBehavior</q>
        <ul class="bullet">
            <li>Prevents overloading of a service</li>
            <li>Default values are usually too strict</li>
        </ul>
    </div>

    <div class="step" data-x="11000" data-y="-1500">
        <q>WCF service instance management</q>
        <ul class="bullet">
            <li>PerCall</li>
            <li>PerSession</li>
            <li>Single</li>
        </ul>
    </div>

    <div class="step" data-x="12000" data-y="-1500">
        <q>ServiceThrottlingBehavior properties</q>
        <ul class="bullet">
            <li>MaxConcurrentCalls <div class="small-text">v3.0: 16, v4: 16*CoreCount</div></li>
            <li>MaxConcurrentSessions <div class="small-text">v3.0: 10, v4: 100*CoreCount</div></li>
            <li>MaxConcurrentInstances <div class="small-text">v3.0, v4: MaxCocurrentCalls+MaxConcurrentSessions</div></li>
        </ul>
    </div>

    <div class="step" data-x="13000" data-y="-1500">
        <q>Demo #2. Tuning ServiceThrottlingBehavior</q>
    </div>

    <div class="step" data-x="14000" data-y="-1500">
        <q>Handling burst of requests after being idle</q>
        <ul class="bullet">
            <li>Every request is important</li>
            <li>No excuse for "Oh, timeout? Please try again, our system needs a warm up"</li>
        </ul>
    </div>

    <div class="step" data-x="15000" data-y="-1500">
        <q>WCF slowiness issue after being idle for 15 sec</q>
        <ul class="bullet">
            <li>WCF uses completion ports (IOCP) thread pool for request processing</li>
            <li>There is a 15 sec timeout for IOCP thread pool</li>
            <li>Thread pool takes time to create new threads for incoming requests</li>
            <li>Issue still not fixed in .NET 4</li>
        </ul>
        <div><a class="source-link" href="http://blogs.msdn.com/b/wenlong/archive/2010/02/11/why-does-wcf-become-slow-after-being-idle-for-15-seconds.aspx">http://blogs.msdn.com/b/wenlong/archive/2010/02/11/why-does-wcf-become-slow-after-being-idle-for-15-seconds.aspx</a></div>
    </div>

    <div class="step" data-x="16000" data-y="-1500">
        <q>Demo #3. WCF slowiness issue after being idle for 15 sec</q>
    </div>

    <div class="step" data-x="17000" data-y="-1500">
        <q>Asynchronous operations</q>
        <ul class="bullet">
            <li>WCF service operations supports APM</li>
            <li>Should help on blocking operations: r/w file, network stream</li>
        </ul>
    </div>

    <div class="step" data-x="18000" data-y="-1500">
        <q>Demo #4. AsyncPattern=true</q>
    </div>

    <div class="step" data-x="19000" data-y="-1500">
        <q>Thanks! Further topics for this evening</q>
        <ul class="bullet">
            <li>Any more tips to add?</li>
            <li>Alternatives to WCF?</li>
            <li>Questions?</li>
        </ul>
    </div>

<script src="js/impress.js" type="text/javascript"></script>

</body>
</html>
